#!/bin/bash

umask 0022 # TODO - check this gives read to all (think vfat)

# get the pid of this instance of amon
AMONPID=$$

# always cd to amondir to make paths simple.
AMONDIR=`dirname $0`
cd ${AMONDIR}
BASE=.
AMONLOG=${BASE}/amon.log
STATEFILE=${BASE}/state
PIDFILE=${BASE}/pidfile

### read the config file(s) and function definitions.
[ ! -r defs.sh ] && echo "Fatal: no config file defs.sh. I give up." && exit -1
source defs.sh

[ ! -r amon.conf ] && log "Fatal: no config file amon.conf. I give up." && exit -1
source amon.conf

[ -r /boot/amon.conf ] && { 
#    echo "Reading additional config file: /boot/amon.conf" 
    source /boot/amon.conf
}

### these must come AFTER reading the configs.
WAVDIR=${AMONDATA}/wavs
ALOG=${WAVDIR}/arecord.log

# what if there is no state file?
if [ ! -r $STATEFILE ] ; then
  log "INFO: No statefile \"$STATEFILE\" - creating one in the \"on\" position"
  echo "on" > $STATEFILE
fi

# what if there is no data directory?
if [ ! -d $WAVDIR ] ; then
    log "INFO: Creating data directory \"$WAVDIR\""
    mkdir $WAVDIR
fi

##########################################
# parse command line
##########################################
[ $# -eq 0 ] && { usage; exit 0;}

if [ xx`type -t amon${1}` = xx"function" ] ; then
    amon${1} $*
elif [ xx`type -t $1` = xx"function" ] ; then
    $1 $*
else
    echo "amon: \"$1\": command not known to amon"
fi

exit 0
